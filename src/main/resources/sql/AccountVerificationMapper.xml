<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moa.dao.openbanking.AccountVerificationMapper">

    <resultMap id="AccountVerificationMap" type="com.moa.domain.openbanking.AccountVerification">
        <id property="verificationId" column="VERIFICATION_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="bankTranId" column="BANK_TRAN_ID"/>
        <result property="bankCode" column="BANK_CODE"/>
        <result property="accountNum" column="ACCOUNT_NUM"/>
        <result property="accountHolder" column="ACCOUNT_HOLDER"/>
        <result property="verifyCode" column="VERIFY_CODE"/>
        <result property="attemptCount" column="ATTEMPT_COUNT"/>
        <result property="status" column="STATUS"/>
        <result property="expiredAt" column="EXPIRED_AT"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 인증 세션 저장 -->
    <insert id="insert" parameterType="com.moa.domain.openbanking.AccountVerification"
            useGeneratedKeys="true" keyProperty="verificationId">
        INSERT INTO ACCOUNT_VERIFICATION (
            USER_ID, BANK_TRAN_ID, BANK_CODE, ACCOUNT_NUM, ACCOUNT_HOLDER,
            VERIFY_CODE, ATTEMPT_COUNT, STATUS, EXPIRED_AT
        ) VALUES (
            #{userId}, #{bankTranId}, #{bankCode}, #{accountNum}, #{accountHolder},
            #{verifyCode}, #{attemptCount}, #{status}, #{expiredAt}
        )
    </insert>

    <!-- 거래고유번호로 조회 -->
    <select id="findByBankTranId" resultMap="AccountVerificationMap">
        SELECT * FROM ACCOUNT_VERIFICATION
        WHERE BANK_TRAN_ID = #{bankTranId}
    </select>

    <!-- 사용자 ID로 최근 인증 세션 조회 -->
    <select id="findLatestByUserId" resultMap="AccountVerificationMap">
        SELECT * FROM ACCOUNT_VERIFICATION
        WHERE USER_ID = #{userId}
        ORDER BY CREATED_AT DESC
        LIMIT 1
    </select>

    <!-- 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE ACCOUNT_VERIFICATION
        SET STATUS = #{status}, UPDATED_AT = NOW()
        WHERE VERIFICATION_ID = #{verificationId}
    </update>

    <!-- 시도 횟수 증가 -->
    <update id="incrementAttemptCount">
        UPDATE ACCOUNT_VERIFICATION
        SET ATTEMPT_COUNT = ATTEMPT_COUNT + 1, UPDATED_AT = NOW()
        WHERE VERIFICATION_ID = #{verificationId}
    </update>

    <!-- 만료된 세션 일괄 업데이트 -->
    <update id="updateExpiredSessions">
        UPDATE ACCOUNT_VERIFICATION
        SET STATUS = 'EXPIRED', UPDATED_AT = NOW()
        WHERE STATUS = 'PENDING' AND EXPIRED_AT &lt; NOW()
    </update>

</mapper>
