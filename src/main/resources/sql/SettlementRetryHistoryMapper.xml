<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moa.dao.settlement.SettlementRetryHistoryDao">

    <!-- ResultMap -->
    <resultMap id="SettlementRetryHistoryMap" type="com.moa.domain.SettlementRetryHistory">
        <id property="retryId" column="RETRY_ID"/>
        <result property="settlementId" column="SETTLEMENT_ID"/>
        <result property="partyId" column="PARTY_ID"/>
        <result property="partyLeaderId" column="PARTY_LEADER_ID"/>
        <result property="accountId" column="ACCOUNT_ID"/>
        <result property="attemptNumber" column="ATTEMPT_NUMBER"/>
        <result property="attemptDate" column="ATTEMPT_DATE"/>
        <result property="retryReason" column="RETRY_REASON"/>
        <result property="retryStatus" column="RETRY_STATUS"/>
        <result property="nextRetryDate" column="NEXT_RETRY_DATE"/>
        <result property="transferAmount" column="TRANSFER_AMOUNT"/>
        <result property="errorCode" column="ERROR_CODE"/>
        <result property="errorMessage" column="ERROR_MESSAGE"/>
        <result property="bankRspCode" column="BANK_RSP_CODE"/>
        <result property="bankRspMessage" column="BANK_RSP_MESSAGE"/>
        <result property="bankTranId" column="BANK_TRAN_ID"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 재시도 이력 등록 -->
    <insert id="insertRetry" parameterType="com.moa.domain.SettlementRetryHistory" 
            useGeneratedKeys="true" keyProperty="retryId">
        INSERT INTO SETTLEMENT_RETRY_HISTORY (
            SETTLEMENT_ID,
            PARTY_ID,
            PARTY_LEADER_ID,
            ACCOUNT_ID,
            ATTEMPT_NUMBER,
            ATTEMPT_DATE,
            RETRY_REASON,
            RETRY_STATUS,
            NEXT_RETRY_DATE,
            TRANSFER_AMOUNT,
            ERROR_CODE,
            ERROR_MESSAGE,
            BANK_RSP_CODE,
            BANK_RSP_MESSAGE,
            BANK_TRAN_ID,
            CREATED_AT
        ) VALUES (
            #{settlementId},
            #{partyId},
            #{partyLeaderId},
            #{accountId},
            #{attemptNumber},
            #{attemptDate},
            #{retryReason},
            #{retryStatus},
            #{nextRetryDate},
            #{transferAmount},
            #{errorCode},
            #{errorMessage},
            #{bankRspCode},
            #{bankRspMessage},
            #{bankTranId},
            NOW()
        )
    </insert>

    <!-- ID로 조회 -->
    <select id="findById" resultMap="SettlementRetryHistoryMap">
        SELECT * FROM SETTLEMENT_RETRY_HISTORY 
        WHERE RETRY_ID = #{retryId}
    </select>

    <!-- 정산 ID로 이력 조회 -->
    <select id="findBySettlementId" resultMap="SettlementRetryHistoryMap">
        SELECT * FROM SETTLEMENT_RETRY_HISTORY 
        WHERE SETTLEMENT_ID = #{settlementId}
        ORDER BY ATTEMPT_NUMBER ASC
    </select>

    <!-- 대기 중인 재시도 목록 조회 -->
    <select id="findPendingRetries" resultMap="SettlementRetryHistoryMap">
        SELECT * FROM SETTLEMENT_RETRY_HISTORY
        WHERE RETRY_STATUS IN ('PENDING', 'FAILED')
          AND NEXT_RETRY_DATE IS NOT NULL
          AND NEXT_RETRY_DATE &lt;= NOW()
        ORDER BY NEXT_RETRY_DATE ASC
    </select>

    <!-- 재시도 상태 업데이트 -->
    <update id="updateRetryStatus" parameterType="com.moa.domain.SettlementRetryHistory">
        UPDATE SETTLEMENT_RETRY_HISTORY
        SET RETRY_STATUS = #{retryStatus},
            ERROR_CODE = #{errorCode},
            ERROR_MESSAGE = #{errorMessage},
            BANK_RSP_CODE = #{bankRspCode},
            BANK_RSP_MESSAGE = #{bankRspMessage},
            BANK_TRAN_ID = #{bankTranId},
            NEXT_RETRY_DATE = #{nextRetryDate},
            UPDATED_AT = NOW()
        WHERE RETRY_ID = #{retryId}
    </update>

    <!-- 특정 정산의 최신 재시도 이력 조회 -->
    <select id="findLatestBySettlementId" resultMap="SettlementRetryHistoryMap">
        SELECT * FROM SETTLEMENT_RETRY_HISTORY
        WHERE SETTLEMENT_ID = #{settlementId}
        ORDER BY ATTEMPT_NUMBER DESC
        LIMIT 1
    </select>

    <!-- 시도 횟수 조회 -->
    <select id="countBySettlementId" resultType="int">
        SELECT COUNT(*) FROM SETTLEMENT_RETRY_HISTORY
        WHERE SETTLEMENT_ID = #{settlementId}
    </select>

</mapper>
