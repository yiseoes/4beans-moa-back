<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.moa.dao.payment.PaymentDao">

    <!-- ====================================== -->
    <!-- ResultMap 정의 -->
    <!-- ====================================== -->

    <!-- Payment 기본 ResultMap -->
    <resultMap id="PaymentResultMap" type="com.moa.domain.Payment">
        <id property="paymentId" column="PAYMENT_ID"/>
        <result property="partyId" column="PARTY_ID"/>
        <result property="partyMemberId" column="PARTY_MEMBER_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="paymentType" column="PAYMENT_TYPE"/>
        <result property="paymentAmount" column="PAYMENT_AMOUNT"/>
        <result property="paymentStatus" column="PAYMENT_STATUS"/>
        <result property="paymentMethod" column="PAYMENT_METHOD"/>
        <result property="paymentDate" column="PAYMENT_DATE"/>
        <result property="tossPaymentKey" column="TOSS_PAYMENT_KEY"/>
        <result property="orderId" column="ORDER_ID"/>
        <result property="cardNumber" column="CARD_NUMBER"/>
        <result property="cardCompany" column="CARD_COMPANY"/>
        <result property="targetMonth" column="TARGET_MONTH"/>
    </resultMap>

    <!-- PaymentResponse ResultMap (목록용) -->
    <resultMap id="PaymentResponseResultMap" type="com.moa.dto.payment.response.PaymentResponse">
        <id property="paymentId" column="PAYMENT_ID"/>
        <result property="partyId" column="PARTY_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="partyMemberId" column="PARTY_MEMBER_ID"/>
        <result property="paymentType" column="PAYMENT_TYPE"/>
        <result property="paymentAmount" column="PAYMENT_AMOUNT"/>
        <result property="paymentStatus" column="PAYMENT_STATUS"/>
        <result property="paymentMethod" column="PAYMENT_METHOD"/>
        <result property="paymentDate" column="PAYMENT_DATE"/>
        <result property="targetMonth" column="TARGET_MONTH"/>

        <!-- 카드 정보 -->
        <result property="cardNumber" column="CARD_NUMBER"/>
        <result property="cardCompany" column="CARD_COMPANY"/>

        <!-- JOIN 데이터 -->
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="partyLeaderNickname" column="PARTY_LEADER_NICKNAME"/>
        <result property="userNickname" column="USER_NICKNAME"/>

        <!-- 재시도 정보 (PAYMENT_RETRY_HISTORY JOIN) -->
        <result property="retryStatus" column="RETRY_STATUS"/>
    </resultMap>

    <!-- PaymentDetailResponse ResultMap (상세용) -->
    <resultMap id="PaymentDetailResponseResultMap" type="com.moa.dto.payment.response.PaymentDetailResponse">
        <id property="paymentId" column="PAYMENT_ID"/>
        <result property="partyId" column="PARTY_ID"/>
        <result property="partyMemberId" column="PARTY_MEMBER_ID"/>
        <result property="userId" column="USER_ID"/>
        <result property="paymentType" column="PAYMENT_TYPE"/>
        <result property="paymentAmount" column="PAYMENT_AMOUNT"/>
        <result property="paymentStatus" column="PAYMENT_STATUS"/>
        <result property="paymentMethod" column="PAYMENT_METHOD"/>
        <result property="paymentDate" column="PAYMENT_DATE"/>
        <result property="targetMonth" column="TARGET_MONTH"/>
        <result property="tossPaymentKey" column="TOSS_PAYMENT_KEY"/>
        <result property="orderId" column="ORDER_ID"/>
        <result property="cardNumber" column="CARD_NUMBER"/>
        <result property="cardCompany" column="CARD_COMPANY"/>

        <!-- JOIN 데이터 -->
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="productImage" column="PRODUCT_IMAGE"/>
        <result property="partyLeaderNickname" column="PARTY_LEADER_NICKNAME"/>
        <result property="userNickname" column="USER_NICKNAME"/>

        <!-- 재시도 정보 -->
        <result property="retryStatus" column="RETRY_STATUS"/>
        <result property="attemptNumber" column="ATTEMPT_NUMBER"/>
        <result property="nextRetryDate" column="NEXT_RETRY_DATE"/>
        <result property="retryReason" column="RETRY_REASON"/>
        <result property="errorMessage" column="ERROR_MESSAGE"/>
        <result property="canRetry" column="CAN_RETRY"/>
    </resultMap>

    <!-- ====================================== -->
    <!-- INSERT -->
    <!-- ====================================== -->

    <!-- 결제 생성 -->
    <insert id="insertPayment" parameterType="com.moa.domain.Payment"
            useGeneratedKeys="true" keyProperty="paymentId" keyColumn="PAYMENT_ID">
        INSERT INTO PAYMENT (
            PARTY_ID,
            PARTY_MEMBER_ID,
            USER_ID,
            PAYMENT_TYPE,
            PAYMENT_AMOUNT,
            PAYMENT_STATUS,
            PAYMENT_METHOD,
            PAYMENT_DATE,
            TOSS_PAYMENT_KEY,
            ORDER_ID,
            CARD_NUMBER,
            CARD_COMPANY,
            TARGET_MONTH
        ) VALUES (
                     #{partyId},
                     #{partyMemberId},
                     #{userId},
                     #{paymentType},
                     #{paymentAmount},
                     #{paymentStatus},
                     #{paymentMethod},
                     #{paymentDate},
                     #{tossPaymentKey},
                     #{orderId},
                     #{cardNumber},
                     #{cardCompany},
                     #{targetMonth}
                 )
    </insert>

    <!-- ====================================== -->
    <!-- SELECT -->
    <!-- ====================================== -->

    <!-- 결제 ID로 조회 -->
    <select id="findById" parameterType="int" resultMap="PaymentResultMap">
        SELECT *
        FROM PAYMENT
        WHERE PAYMENT_ID = #{paymentId}
    </select>

    <!-- 결제 상세 조회 (JOIN) -->
    <select id="findDetailById" parameterType="int" resultMap="PaymentDetailResponseResultMap">
        SELECT
            PAY.PAYMENT_ID,
            PAY.PARTY_ID,
            PAY.PARTY_MEMBER_ID,
            PAY.USER_ID,
            PAY.PAYMENT_TYPE,
            PAY.PAYMENT_AMOUNT,
            PAY.PAYMENT_STATUS,
            PAY.PAYMENT_METHOD,
            PAY.PAYMENT_DATE,
            PAY.TARGET_MONTH,
            PAY.TOSS_PAYMENT_KEY,
            PAY.ORDER_ID,
            PAY.CARD_NUMBER,
            PAY.CARD_COMPANY,

            -- 파티/상품 정보
            PROD.PRODUCT_NAME,
            PROD.IMAGE AS PRODUCT_IMAGE,
            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,

            -- 사용자 정보
            U.NICKNAME AS USER_NICKNAME,

            -- 재시도 정보 (가장 최근 시도만)
            RETRY.RETRY_STATUS,
            RETRY.ATTEMPT_NUMBER,
            RETRY.NEXT_RETRY_DATE,
            RETRY.RETRY_REASON,
            RETRY.ERROR_MESSAGE,

            -- 재시도 가능 여부 계산 (FAILED 상태이고 시도 횟수가 4회 미만)
            CASE
                WHEN PAY.PAYMENT_STATUS = 'FAILED' AND (RETRY.ATTEMPT_NUMBER IS NULL OR RETRY.ATTEMPT_NUMBER &lt; 4)
                THEN TRUE
                ELSE FALSE
            END AS CAN_RETRY
        FROM PAYMENT PAY
                 INNER JOIN PARTY P ON PAY.PARTY_ID = P.PARTY_ID
                 INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
                 INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
                 INNER JOIN USERS U ON PAY.USER_ID = U.USER_ID
                 LEFT JOIN (
            -- 각 결제의 가장 최근 재시도 기록만 가져오기
            SELECT PRT.*
            FROM PAYMENT_RETRY_HISTORY PRT
                     INNER JOIN (
                SELECT PAYMENT_ID, MAX(ATTEMPT_NUMBER) as MAX_ATTEMPT
                FROM PAYMENT_RETRY_HISTORY
                GROUP BY PAYMENT_ID
            ) LATEST ON PRT.PAYMENT_ID = LATEST.PAYMENT_ID
                AND PRT.ATTEMPT_NUMBER = LATEST.MAX_ATTEMPT
        ) RETRY ON PAY.PAYMENT_ID = RETRY.PAYMENT_ID
        WHERE PAY.PAYMENT_ID = #{paymentId}
    </select>

    <!-- 사용자 ID로 결제 목록 조회 -->
    <select id="findByUserId" parameterType="string" resultMap="PaymentResponseResultMap">
        SELECT
            PAY.PAYMENT_ID,
            PAY.PARTY_ID,
            PAY.USER_ID,
            PAY.PARTY_MEMBER_ID,
            PAY.PAYMENT_TYPE,
            PAY.PAYMENT_AMOUNT,
            PAY.PAYMENT_STATUS,
            PAY.PAYMENT_METHOD,
            PAY.PAYMENT_DATE,
            PAY.TARGET_MONTH,
            PAY.CARD_NUMBER,
            PAY.CARD_COMPANY,

            PROD.PRODUCT_NAME,
            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,
            -- 목록에는 본인 닉네임 불필요

            -- 재시도 정보 (가장 최근 시도만)
            RETRY.RETRY_STATUS,
            RETRY.ATTEMPT_NUMBER,
            RETRY.NEXT_RETRY_DATE,
            RETRY.RETRY_REASON,
            RETRY.ERROR_MESSAGE
        FROM PAYMENT PAY
                 INNER JOIN PARTY P ON PAY.PARTY_ID = P.PARTY_ID
                 INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
                 INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
                 LEFT JOIN (
            -- 각 결제의 가장 최근 재시도 기록만 가져오기
            SELECT PRT.*
            FROM PAYMENT_RETRY_HISTORY PRT
                     INNER JOIN (
                SELECT PAYMENT_ID, MAX(ATTEMPT_NUMBER) as MAX_ATTEMPT
                FROM PAYMENT_RETRY_HISTORY
                GROUP BY PAYMENT_ID
            ) LATEST ON PRT.PAYMENT_ID = LATEST.PAYMENT_ID
                AND PRT.ATTEMPT_NUMBER = LATEST.MAX_ATTEMPT
        ) RETRY ON PAY.PAYMENT_ID = RETRY.PAYMENT_ID
        WHERE PAY.USER_ID = #{userId}
        ORDER BY PAY.PAYMENT_DATE DESC
    </select>

    <!-- 파티 ID로 결제 목록 조회 -->
    <select id="findByPartyId" parameterType="int" resultMap="PaymentResponseResultMap">
        SELECT
            PAY.PAYMENT_ID,
            PAY.PARTY_ID,
            PAY.USER_ID,
            PAY.PARTY_MEMBER_ID,
            PAY.PAYMENT_TYPE,
            PAY.PAYMENT_AMOUNT,
            PAY.PAYMENT_STATUS,
            PAY.PAYMENT_METHOD,
            PAY.PAYMENT_DATE,
            PAY.TARGET_MONTH,
            PAY.CARD_NUMBER,
            PAY.CARD_COMPANY,

            PROD.PRODUCT_NAME,
            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,
            U.NICKNAME AS USER_NICKNAME,

            -- 재시도 정보 (가장 최근 시도만)
            RETRY.RETRY_STATUS,
            RETRY.ATTEMPT_NUMBER,
            RETRY.NEXT_RETRY_DATE,
            RETRY.RETRY_REASON,
            RETRY.ERROR_MESSAGE
        FROM PAYMENT PAY
                 INNER JOIN PARTY P ON PAY.PARTY_ID = P.PARTY_ID
                 INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
                 INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
                 INNER JOIN USERS U ON PAY.USER_ID = U.USER_ID
                 LEFT JOIN (
            -- 각 결제의 가장 최근 재시도 기록만 가져오기
            SELECT PRT.*
            FROM PAYMENT_RETRY_HISTORY PRT
                     INNER JOIN (
                SELECT PAYMENT_ID, MAX(ATTEMPT_NUMBER) as MAX_ATTEMPT
                FROM PAYMENT_RETRY_HISTORY
                GROUP BY PAYMENT_ID
            ) LATEST ON PRT.PAYMENT_ID = LATEST.PAYMENT_ID
                AND PRT.ATTEMPT_NUMBER = LATEST.MAX_ATTEMPT
        ) RETRY ON PAY.PAYMENT_ID = RETRY.PAYMENT_ID
        WHERE PAY.PARTY_ID = #{partyId}
        ORDER BY PAY.PAYMENT_DATE DESC
    </select>

    <!-- 파티 멤버 ID + 대상 월로 결제 조회 (중복 결제 확인용) -->
    <select id="findByPartyMemberIdAndTargetMonth" resultMap="PaymentResultMap">
        SELECT *
        FROM PAYMENT
        WHERE PARTY_MEMBER_ID = #{partyMemberId}
          AND TARGET_MONTH = #{targetMonth}
    </select>

    <!-- 주문 ID로 결제 조회 (중복 결제 확인용) -->
    <select id="findByOrderId" parameterType="string" resultMap="PaymentResultMap">
        SELECT *
        FROM PAYMENT
        WHERE ORDER_ID = #{orderId}
    </select>

    <!-- 파티 멤버 ID + 결제 유형으로 조회 (환불용) -->
    <select id="findByPartyMemberIdAndType" resultMap="PaymentResultMap">
        SELECT *
        FROM PAYMENT
        WHERE PARTY_MEMBER_ID = #{partyMemberId}
          AND PAYMENT_TYPE = #{paymentType}
        LIMIT 1
    </select>

    <!-- ====================================== -->
    <!-- UPDATE -->
    <!-- ====================================== -->

    <!-- 결제 상태 업데이트 -->
    <update id="updatePaymentStatus">
        UPDATE PAYMENT
        SET PAYMENT_STATUS = #{status}
        WHERE PAYMENT_ID = #{paymentId}
    </update>

    <!-- 정산 ID 업데이트 (비정규화 - SETTLEMENT_DETAIL 테이블 제거로 인해 추가) -->
    <update id="updateSettlementId">
        UPDATE PAYMENT
        SET SETTLEMENT_ID = #{settlementId}
        WHERE PAYMENT_ID = #{paymentId}
    </update>

    <!-- 정산 ID로 결제 내역 조회 (정산 상세 조회용) -->
    <select id="findBySettlementId" parameterType="int" resultMap="PaymentResponseResultMap">
        SELECT
            PAY.PAYMENT_ID,
            PAY.PARTY_ID,
            PAY.USER_ID,
            PAY.PARTY_MEMBER_ID,
            PAY.PAYMENT_TYPE,
            PAY.PAYMENT_AMOUNT,
            PAY.PAYMENT_STATUS,
            PAY.PAYMENT_METHOD,
            PAY.PAYMENT_DATE,
            PAY.TARGET_MONTH,
            PAY.CARD_NUMBER,
            PAY.CARD_COMPANY,
            PROD.PRODUCT_NAME,
            LEADER.NICKNAME AS PARTY_LEADER_NICKNAME,
            U.NICKNAME AS USER_NICKNAME
        FROM PAYMENT PAY
        INNER JOIN PARTY P ON PAY.PARTY_ID = P.PARTY_ID
        INNER JOIN USERS LEADER ON P.PARTY_LEADER_ID = LEADER.USER_ID
        INNER JOIN PRODUCT PROD ON P.PRODUCT_ID = PROD.PRODUCT_ID
        INNER JOIN USERS U ON PAY.USER_ID = U.USER_ID
        WHERE PAY.SETTLEMENT_ID = #{settlementId}
        ORDER BY PAY.PAYMENT_DATE ASC
    </select>

    <!-- 대시보드용: 총 매출 (COMPLETED 상태인 결제 금액 합계) -->
    <select id="calculateTotalRevenue" resultType="long">
        SELECT COALESCE(SUM(PAYMENT_AMOUNT), 0)
        FROM PAYMENT
        WHERE PAYMENT_STATUS = 'COMPLETED'
    </select>

</mapper>